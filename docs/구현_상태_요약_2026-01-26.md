# 구현 상태 요약 (2026-01-26)

**작성일**: 2026-01-26  
**버전**: 1.0  
**프로젝트명**: Avatar Forge (인생 극장)

---

## 📋 목차

1. [전체 구현 현황](#1-전체-구현-현황)
2. [TTS API 구현 상세](#2-tts-api-구현-상세)
3. [캐릭터 선택/생성 기능 구현 상세](#3-캐릭터-선택생성-기능-구현-상세)
4. [캐릭터 API 구현 상세](#4-캐릭터-api-구현-상세)
5. [개선 작업 완료 내역](#5-개선-작업-완료-내역)
6. [문서 정합성 업데이트 필요 사항](#6-문서-정합성-업데이트-필요-사항)

---

## 1. 전체 구현 현황

### 1.1 Backend 구현 완료 항목 ✅

#### ✅ TTS API (`app/api/tts.py`)
- **파일 위치**: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/tts.py`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - `POST /api/tts` - 텍스트-음성 변환 (완전 구현)
  - `GET /api/tts/voices` - 음성 목록 조회 (완전 구현)
  - Server A GPT-SoVITS 연동 (완전 구현)
  - 캐싱 시스템 (데이터베이스 기반)
  - 오디오 파일 메타데이터 분석 (mutagen 사용)
  - 사용자별 파일 저장 (`/mnt/user_assets/{user_id}/`)
  - 바이너리 직접 반환 옵션 (`return_binary`)
  - streaming_mode 지원 (0-3)
  - voice_id 매핑 시스템 (`app/config/voices.json`)

#### ✅ 캐릭터 API (`app/api/characters.py`)
- **파일 위치**: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/characters.py`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - `GET /api/characters/presets` - 사전설정 캐릭터 목록 조회
  - `GET /api/characters` - 사용자 저장 캐릭터 목록 조회
  - `POST /api/characters` - 새 캐릭터 생성
  - `GET /api/characters/{character_id}` - 캐릭터 상세 조회
  - `PUT /api/characters/{character_id}` - 캐릭터 수정
  - `DELETE /api/characters/{character_id}` - 캐릭터 삭제
  - 파일 변경 감지 기반 캐싱 (mtime 추적)
  - 사전설정 캐릭터 JSON 파일 로드 (`app/config/characters.json`)

#### ✅ AI 생성 API (`app/api/ai.py`)
- **파일 위치**: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/ai.py`
- **구현 상태**: ✅ 완전 구현 완료 (Gemini SDK 도입 완료, 2026-01-26)
- **주요 기능**:
  - `POST /api/ai/generate/story` - 상황 분석 및 드라마틱한 줄거리 생성
  - `POST /api/ai/generate/character-details` - 캐릭터 상세 설정 자동 생성 (JSON)
  - **Google Generative AI SDK (`google-generativeai`) 도입**:
    - 비동기 API 호출 (`generate_content_async`)
    - JSON Mode 지원 (`response_mime_type="application/json"`)
    - Safety Settings 적용 (기본값: BLOCK_NONE, 환경변수로 조절 가능)
    - System Instruction 지원
    - 환경변수 기반 설정 (GOOGLE_API_KEY, GOOGLE_API_MODEL, GOOGLE_SAFETY_THRESHOLD)
  - **참고 문서**:
    - [Gemini API 사용해보기](https://velog.io/@dyd1308/Gemini-api-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0)
    - [Gemini 모델 버전](https://ai.google.dev/gemini-api/docs/models?hl=ko#model-versions)

#### ✅ Character 모델 확장 (`app/models/generation.py`)
- **구현 상태**: ✅ 완전 구현 완료
- **추가된 필드**:
  - `persona`: 캐릭터 페르소나 설명 (텍스트)
  - `voice_id`: TTS 음성 ID (기본값: "default")
  - `character`: 캐릭터 속성 (JSON)

### 1.2 Frontend 구현 완료 항목 ✅

#### ✅ 캐릭터 선택 모달 (`components/character-select-modal.tsx`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/components/character-select-modal.tsx`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - 사전설정 캐릭터 탭 (로컬 JSON 우선 로드, 백엔드 폴백)
  - 저장된 캐릭터 탭
  - 새로 만들기 탭 (CharacterCreationWizard 연결)
  - 캐릭터 선택 확인 모달
  - 반응형 그리드 레이아웃 (모바일 1열, 태블릿 2열, 데스크톱 3열)
  - Lazy loading (CharacterCreationWizard)
  - Toast 기반 에러 처리
  - 네트워크 에러 처리 및 타임아웃

#### ✅ 캐릭터 생성 위저드 (`components/character-creation-wizard.tsx`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/components/character-creation-wizard.tsx`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - 4단계 위저드 (이름/작품 입력, Persona 상세 입력, Voice 선택, 미리보기)
  - AI 자동 생성 (Gemini API 연동)
  - Persona 구조화 파싱 (personality, speechStyle, background, goals)
  - Voice 미리보기 (TTS API 연동)
  - Toast 기반 에러 처리
  - 접근성 개선 (ARIA 속성, 키보드 네비게이션)
  - 메모이제이션 (useCallback, useMemo)

#### ✅ 캐릭터 카드 컴포넌트 (`components/character-card.tsx`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/components/character-card.tsx`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - 이미지 Fallback 체인 (캐릭터별 → 카테고리별 → 기본 placeholder)
  - 접근성 개선 (ARIA 속성, 키보드 네비게이션)
  - Lazy loading 이미지

#### ✅ API 클라이언트 확장 (`lib/api/client.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/api/client.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - `characterApi.listPresets()` - 로컬 JSON 우선, 백엔드 폴백
  - `characterApi.listUserCharacters()` - 사용자 캐릭터 목록
  - `characterApi.createCharacter()` - 캐릭터 생성
  - `fetchWithTimeout` - 10초 타임아웃
  - 향상된 에러 처리 (`handleResponse` 개선)

#### ✅ 캐릭터 API Route (`app/api/characters/route.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/app/api/characters/route.ts`
- **구현 상태**: ✅ 완전 구현 완료 (비동기 처리 개선 완료, 2026-01-26)
- **주요 기능**:
  - `GET /api/characters` - `public/characters/*.json` 파일 동적 로드
  - **비동기 처리 개선**:
    - 동기식 파일 처리(`fs.readFileSync`) → 비동기식(`fs.promises`) 전환
    - `Promise.all()`을 사용한 병렬 파일 로드
    - 예외 처리 강화 (각 파일별 try-catch)
    - 디렉토리 존재 확인 (`fs.promises.access`)
    - 파일 타입 확인 (`stats.isFile()`)
  - 자동 마이그레이션: 파일 로드 시 `persona` 필드 자동 제거
  - 프리셋 우선 정렬 (안전한 정렬 로직)
  - 에러 로깅 강화

#### ✅ 설정 파일 (`lib/config/character.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/config/character.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 내용**:
  - Gemini API URL 설정
  - 캐릭터 미리보기 텍스트
  - 그리드 레이아웃 설정
  - 모달 크기 설정
  - 이미지 Fallback 경로

#### ✅ Persona 파서 (`lib/utils/persona-parser.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/utils/persona-parser.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - `parsePersona()` - 텍스트에서 구조화된 필드 추출
  - `buildPersonaFromParsed()` - 구조화된 필드에서 텍스트 재구성

#### ✅ 에러 처리 시스템 (`lib/api/errors.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/api/errors.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - `ErrorCode` enum 정의
  - `AppError` 인터페이스
  - `toAppError()` - 에러 변환 함수
  - `getErrorMessage()` - 사용자 친화적 메시지

#### ✅ Zustand Store 확장 (`lib/store.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/store.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **추가된 상태**:
  - `AppStep`: `"character-select"` 추가
  - `Character` 인터페이스
  - `selectedCharacter` 상태

#### ✅ Gemini API 클라이언트 (`lib/api/gemini.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/api/gemini.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - `generateCharacterSpec()` - AI 캐릭터 상세 설정 생성 (JSON)
  - 재시도 로직 (지수 백오프, 최대 3회)
  - 구조화된 JSON 응답 요청
  - 작품명 기반 생성 (`source_work` 필드)
  - `worldview` 필드 자동 생성

#### ✅ 백엔드 Gemini SDK (`app/api/ai.py`)
- **파일 위치**: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/ai.py`
- **구현 상태**: ✅ 완전 구현 완료 (Gemini SDK 도입 완료, 2026-01-26)
- **주요 기능**:
  - `POST /api/ai/generate/story` - 상황 분석 및 드라마틱한 줄거리 생성
  - `POST /api/ai/generate/character-details` - 캐릭터 상세 설정 자동 생성 (JSON)
  - **Google Generative AI SDK (`google-generativeai`) 사용**:
    - 공식 Python SDK 사용으로 코드 간소화 및 안정성 향상
    - 비동기 API 호출 (`generate_content_async`)
    - JSON Mode 지원 (`response_mime_type="application/json"`)
    - System Instruction 지원 (`system_instruction` 파라미터)
  - **Safety Settings 적용**:
    - 기본값: `BLOCK_NONE` (무검열)
    - 환경변수로 조절 가능 (`GOOGLE_SAFETY_THRESHOLD`)
  - **환경변수 기반 설정**:
    - `GOOGLE_API_KEY`: Gemini API 키 (필수)
    - `GOOGLE_API_MODEL`: 사용할 모델 (기본값: `gemini-1.5-flash`)
    - `GOOGLE_SAFETY_THRESHOLD`: 안전 설정 (기본값: `BLOCK_NONE`)
  - 성능 모니터링: API 호출 시간 측정 및 로깅
- **의존성**: `google-generativeai` 패키지 (`requirements.txt`에 추가됨)
- **참고 문서**:
  - [Gemini API 사용해보기](https://velog.io/@dyd1308/Gemini-api-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0)
  - [Gemini 모델 버전](https://ai.google.dev/gemini-api/docs/models?hl=ko#model-versions)

#### ✅ 공개 캐릭터 JSON (`public/characters/*.json`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/public/characters/*.json` (9개 파일)
- **구현 상태**: ✅ 완전 구현 완료
- **용도**: 백엔드 서버가 없을 때도 사전설정 캐릭터 표시 가능
- **비동기 처리**: `app/api/characters/route.ts`에서 비동기 파일 로드 (2026-01-26)

---

## 2. TTS API 구현 상세

### 2.1 엔드포인트

#### `POST /api/tts`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 텍스트를 음성으로 변환
- **주요 파라미터**:
  - `text`: 합성할 텍스트 (필수)
  - `voice_id`: 음성 ID (선택, 기본값: "default")
  - `ref_audio_path`: 참조 오디오 경로 (선택, voice_id 대신 사용 가능)
  - `streaming_mode`: 스트리밍 모드 (0-3, 기본값: 0)
  - `return_binary`: 바이너리 직접 반환 여부 (기본값: false)
  - 기타 GPT-SoVITS 파라미터 지원
- **응답**:
  - `return_binary=true`: 오디오 바이너리 직접 반환
  - `return_binary=false`: JSON 응답 (audio_url, file_id, duration 등)
- **캐싱**: 데이터베이스 기반 (text_hash, voice_id, format 기준)

#### `GET /api/tts/voices`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 사용 가능한 음성 목록 조회
- **응답**: `{success: true, data: {voices: [...], default_voice_id: "default"}}`
- **설정 파일**: `app/config/voices.json`

### 2.2 주요 기능

- **캐싱 시스템**: 동일한 텍스트+voice_id 조합은 데이터베이스에서 재사용
- **오디오 분석**: mutagen을 사용한 메타데이터 추출 (duration, file_size)
- **사용자별 저장**: `/mnt/user_assets/{user_id}/audio/` 경로에 저장
- **에러 처리**: HTTPException 기반 표준화된 에러 응답
- **타임아웃**: 설정 가능한 타임아웃 (기본값: 30초)

### 2.3 의존성

- `mutagen`: 오디오 메타데이터 분석
- `httpx`: 비동기 HTTP 클라이언트
- `sqlalchemy`: 데이터베이스 ORM

---

## 3. 캐릭터 선택/생성 기능 구현 상세

### 3.1 사용자 플로우

1. **모드 선택** (`ModeSelectModal`) → **캐릭터 선택** (`CharacterSelectModal`)
2. **캐릭터 선택 모달**:
   - 사전설정 캐릭터 탭: 로컬 JSON 우선 로드, 백엔드 폴백
   - 저장된 캐릭터 탭: 사용자가 생성한 캐릭터 목록
   - 새로 만들기 탭: 캐릭터 생성 위저드 열기
3. **캐릭터 생성 위저드** (4단계):
   - **1단계**: 이름/작품 입력 또는 AI 자동 생성
   - **2단계**: Persona 상세 입력 (성격, 말투, 배경, 목표)
   - **3단계**: Voice 선택 및 미리보기
   - **4단계**: 미리보기 및 확인
4. **캐릭터 선택 확인** → 다음 단계로 이동 (아바타 업로드 또는 시나리오 설정)

### 3.2 주요 컴포넌트

#### CharacterSelectModal
- **탭 시스템**: 사전설정 / 저장된 캐릭터 / 새로 만들기
- **로딩 전략**: 탭별 지연 로딩 (필요할 때만 로드)
- **에러 처리**: Toast 기반, 네트워크 에러는 조용히 처리
- **반응형**: 모바일 1열, 태블릿 2열, 데스크톱 3열

#### CharacterCreationWizard
- **AI 생성**: Gemini API를 통한 자동 캐릭터 생성
- **Persona 파싱**: 구조화된 필드 자동 추출
- **Voice 미리보기**: TTS API를 통한 음성 미리듣기
- **검증**: 단계별 입력 검증
- **접근성**: ARIA 속성, 키보드 네비게이션

#### CharacterCard
- **이미지 Fallback**: 3단계 Fallback 체인
- **접근성**: 키보드 네비게이션, ARIA 레이블
- **Lazy Loading**: 이미지 지연 로딩

### 3.3 API 통합

#### Frontend → Backend
- `GET /api/characters/presets`: 사전설정 캐릭터 (로컬 JSON 우선)
- `GET /api/characters`: 사용자 캐릭터 목록
- `POST /api/characters`: 새 캐릭터 생성
- `GET /api/tts/voices`: 음성 목록 조회
- `POST /api/tts`: 음성 미리보기

#### Frontend → Gemini API
- `POST https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent`: AI 캐릭터 생성

---

## 4. 캐릭터 API 구현 상세

### 4.1 엔드포인트

#### `GET /api/characters/presets`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 사전설정 캐릭터 목록 조회
- **캐싱**: 파일 변경 감지 기반 (mtime 추적)
- **설정 파일**: `app/config/characters.json`

#### `GET /api/characters`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 사용자가 생성한 캐릭터 목록 조회
- **필터링**: 모든 사용자 생성 캐릭터 조회 (is_preset=False)

#### `POST /api/characters`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 새 캐릭터 생성
- **필수 필드**: `name`, `persona`
- **선택 필드**: `voice_id`, `description`, `category`, `tags`, `image_url`, `character`
- **참고**: user_id는 "anonymous"로 자동 설정됨

#### `GET /api/characters/{character_id}`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 캐릭터 상세 조회
- **권한**: 모든 캐릭터 조회 가능

#### `PUT /api/characters/{character_id}`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 캐릭터 수정
- **권한**: 사전설정 캐릭터는 수정 불가 (403 에러)

#### `DELETE /api/characters/{character_id}`
- **인증**: 불필요 (인증 제거됨)
- **기능**: 캐릭터 삭제
- **권한**: 사전설정 캐릭터는 삭제 불가 (403 에러)

### 4.2 데이터 모델

#### Character (SQLAlchemy)
- `id`: UUID (Primary Key)
- `user_id`: UUID (Foreign Key → users.id)
- `name`: String (캐릭터 이름)
- `persona`: Text (페르소나 설명)
- `voice_id`: String (기본값: "default")
- `description`: Text (선택)
- `category`: String (선택)
- `tags`: JSON (선택)
- `image_url`: String (선택)
- `character`: JSON (선택)
- `is_preset`: Boolean (기본값: false)
- `created_at`: DateTime
- `updated_at`: DateTime

---

## 5. 캐릭터 시스템 고도화 작업 완료 내역 (2026-01-26)

### 5.1 데이터 구조 세분화 ✅

**작업 내용**: 단순 텍스트(persona) 중심에서 10개 이상의 상세 필드 객체 구조로 전환

**주요 변경사항**:
- ✅ 기존 `persona` 필드 대신 상세 필드 구조 도입:
  - `personality`: 성격 (콤마로 구분된 특성들)
  - `appearance`: 외모 (머리, 눈, 체형, 복장 등 상세 묘사)
  - `likes`: 좋아하는 것 (배열)
  - `dislikes`: 싫어하는 것 (배열)
  - `speech_style`: 말투 (구체적인 어조, 어미, 특징)
  - `thoughts`: 생각 (대표적인 속마음 대사)
  - `features`: 특징 (행동 패턴, 독특한 습관)
  - `habits`: 말버릇 (자주 쓰는 감탄사나 의성어)
  - `guidelines`: 가이드라인 (롤플레이 시 주의할 점)
  - 기타: `gender`, `species`, `age`, `height`, `job`, `description`

**데이터 마이그레이션**:
- ✅ 9종 캐릭터 마이그레이션 완료:
  - 유즈, 헤르미온느, 토토로, 셜록, 나루토, 요다, 엘사, 간달프, 피카츄
- ✅ `public/characters/*.json` 파일에 상세 필드 구조로 저장
- ✅ 기존 `persona` 필드는 자동 마이그레이션으로 제거 (API Route에서 처리)

**파일 위치**:
- `madcamp-Screening-Humanity-FRONT/public/characters/*.json` (9개 파일)

### 5.2 파일 기반 관리 시스템 ✅

**작업 내용**: `public/characters/*.json` 파일을 동적으로 로드하는 API Route 구축

**주요 기능**:
- ✅ `app/api/characters/route.ts` 생성:
  - 서버 실행 중 `public/characters` 폴더를 스캔하여 캐릭터 목록 반환
  - 자동 마이그레이션: 파일 로드 시 `persona` 필드가 남아있으면 자동으로 삭제하고 정규화된 스펙으로 덮어쓰기
  - 프리셋 우선 정렬 (is_preset 기준)

**API 클라이언트 수정**:
- ✅ `lib/api/client.ts`:
  - 캐릭터 목록 조회를 정적 import에서 API 호출 방식으로 전환
  - `characterApi.listPresets()` - 로컬 JSON 우선, 백엔드 폴백

**파일 위치**:
- `madcamp-Screening-Humanity-FRONT/app/api/characters/route.ts`

### 5.3 AI 자동 완성 기능 고도화 ✅

**작업 내용**: Gemini AI를 통한 상세 캐릭터 설정 자동 생성

**프론트엔드 구현**:
- ✅ `lib/api/gemini.ts` 개편:
  - `generateCharacterSpec()` 함수 구현: 사용자의 최소 입력만으로 나무위키 수준의 상세 캐릭터 설정을 JSON 형태로 자동 생성
  - 시스템 프롬프트 강화: 더 구체적인 캐릭터성과 풍부한 배경 스토리를 생성하도록 지시
  - **작품명 기반 생성**: `source_work` 필드 추가로 원작 정보를 정확하게 반영
  - 재시도 로직 (지수 백오프, 최대 3회)
  - JSON 파싱 및 정제 (코드 블록 제거)

**백엔드 구현** (2026-01-26):
- ✅ `app/api/ai.py` 리팩토링:
  - **Google Generative AI SDK (`google-generativeai`) 도입**:
    - 공식 Python SDK 사용으로 코드 간소화 및 안정성 향상
    - 비동기 API 호출 (`generate_content_async`)
    - JSON Mode 지원 (`response_mime_type="application/json"`)
    - System Instruction 지원 (`system_instruction` 파라미터)
  - **Safety Settings 적용**:
    - 기본값: `BLOCK_NONE` (무검열)
    - 환경변수로 조절 가능 (`GOOGLE_SAFETY_THRESHOLD`)
    - 지원 값: `BLOCK_NONE`, `BLOCK_ONLY_HIGH`, `BLOCK_MEDIUM_AND_ABOVE`, `BLOCK_LOW_AND_ABOVE`
  - **환경변수 기반 설정**:
    - `GOOGLE_API_KEY`: Gemini API 키 (필수)
    - `GOOGLE_API_MODEL`: 사용할 모델 (기본값: `gemini-1.5-flash`)
    - `GOOGLE_SAFETY_THRESHOLD`: 안전 설정 (기본값: `BLOCK_NONE`)
    - 폴백: `NEXT_PUBLIC_GEMINI_API_KEY` (개발 환경 편의)
  - **성능 모니터링**: API 호출 시간 측정 및 로깅

**입력 파라미터**:
- `name`: 캐릭터 이름 (필수)
- `category`: 카테고리 (필수)
- `source_work`: 작품명(출처) (필수, 신규 추가)
- `concept`: 캐릭터 컨셉/설명 (선택)
- `worldview`: 세계관 (선택, AI가 자동 생성)
- `gender`: 성별 (선택, AI가 자동 생성)
- `species`: 종족 (선택, AI가 자동 생성)

**출력 형식**:
- `CharacterSpec` 인터페이스에 맞는 완전한 JSON 객체
- 모든 필수 필드 자동 생성 (personality, appearance, likes, dislikes, speech_style, thoughts, features, habits, guidelines, **worldview** 등)
- 작품의 고증을 철저히 지켜 생성

**파일 위치**:
- 프론트엔드: `madcamp-Screening-Humanity-FRONT/lib/api/gemini.ts`
- 백엔드: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/ai.py`

**의존성**:
- 백엔드: `google-generativeai` 패키지 (`requirements.txt`에 추가됨)

**환경변수 설정** (백엔드):
- `GOOGLE_API_KEY`: Gemini API 키 (필수)
- `GOOGLE_API_MODEL`: 사용할 모델 (기본값: `gemini-1.5-flash`)
- `GOOGLE_SAFETY_THRESHOLD`: 안전 설정 (기본값: `BLOCK_NONE`)
- 폴백: `NEXT_PUBLIC_GEMINI_API_KEY` (개발 환경 편의)

**참고 문서** (⚠️ **필수 참고**):
- [Gemini API 사용해보기](https://velog.io/@dyd1308/Gemini-api-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0) - Gemini API 사용 시 반드시 참고
- [Gemini 모델 버전](https://ai.google.dev/gemini-api/docs/models?hl=ko#model-versions) - 모델 선택 시 반드시 참고

### 5.4 프론트엔드 UI/UX 혁신 ✅

**작업 내용**: CharacterCreationWizard 전면 개편

**주요 변경사항**:
- ✅ **Step 1 간소화**: 이름, 카테고리, 작품명(출처) 3가지만 입력
  - '다음' 버튼 클릭 시 AI가 자동으로 나머지 모든 상세 정보 생성
  - 작품명 필드 추가로 AI가 원작 정보를 더 정확하게 반영
- ✅ **Step 2 통합 편집**: AI가 생성한 모든 정보를 한 화면에서 확인 및 수정
  - 기본 정보 (성별, 종족, 나이, 키, 직업, 세계관) + 상세 페르소나 통합
  - 'AI 다시 생성' 버튼으로 재시도 가능
- ✅ **AI 재생성 횟수 제한**: 총 3회 생성 가능
  - Step 1에서 '다음' 버튼 클릭 시 (자동 수행, 1회)
  - Step 2 상단 'AI 다시 생성' 버튼 클릭 (최대 2회)
  - UI 표시: 버튼에 남은 횟수 표시 (예: "1회 남음")
  - 모든 기회 소진 시 버튼 비활성화
- ✅ 그리드 레이아웃을 사용한 효율적인 데이터 입력 구조
- ✅ 4단계 위저드:
  1. 기본 정보 (이름, 카테고리, 작품명) - 간소화됨
  2. 상세 정보 (AI 자동 생성 + 수정 가능) - 통합 편집
  3. 음성 선택 및 미리보기
  4. 미리보기 및 확인

**파일 위치**:
- `madcamp-Screening-Humanity-FRONT/components/character-creation-wizard.tsx`

### 5.5 시스템 최적화 (페르소나 빌더) ✅

**작업 내용**: 런타임 페르소나 빌드 시스템 도입

**주요 기능**:
- ✅ `lib/utils/persona-builder.ts` 유틸리티 생성:
  - `buildSystemPersona()` 함수: JSON에 저장된 무거운 문자열을 제거하고, 런타임에 상세 필드들을 조합해 LLM용 시스템 프롬프트를 동적으로 생성
  - 하위 호환성: 기존 `persona` 필드가 있으면 그대로 사용
  - 필드 기반 조합: personality, appearance, description, likes, dislikes, speech_style, thoughts, features, habits, guidelines 등을 조합

**ChatRoom 로직 수정**:
- ✅ `components/chat-room.tsx`:
  - 채팅 시작 및 진행 시 동적으로 빌드된 페르소나와 캐릭터 이름 기반의 명령형 지시문("이제 아래 답변을 받은 OO 처럼 답변하십시오")을 자동 추가
  - `buildSystemPersona(selectedCharacter)` 사용
  - 데이터 중복 제거: 저장 시 무거운 persona 문자열 대신 상세 필드만 저장

**파일 위치**:
- `madcamp-Screening-Humanity-FRONT/lib/utils/persona-builder.ts`
- `madcamp-Screening-Humanity-FRONT/components/chat-room.tsx` (수정)

### 5.6 기대 효과 ✅

**데이터 무결성**:
- ✅ 필드 기반 관리로 데이터 중복을 제거하고 토큰 효율성을 높임
- ✅ 런타임 페르소나 빌드로 항상 최신 상태 반영
- ✅ 자동 마이그레이션으로 기존 데이터 호환성 유지

**사용자 경험**:
- ✅ AI 자동 생성으로 캐릭터 생성 시간 단축
- ✅ 상세 폼 기반 입력으로 더 풍부한 캐릭터 설정 가능
- ✅ 나무위키 수준의 상세한 캐릭터 정보 자동 생성

---

## 6. 개선 작업 완료 내역

### 6.1 에러 처리 개선 ✅

- ✅ 모든 `alert()` 호출을 `useToast()`로 교체
- ✅ 에러 타입 정의 (`ErrorCode`, `AppError`)
- ✅ 재시도 로직 (Gemini API, 지수 백오프)
- ✅ 네트워크 에러 처리 (`fetchWithTimeout`, 10초 타임아웃)
- ✅ 일관된 에러 메시지

### 5.2 하드코딩 제거 ✅

- ✅ Gemini API URL → 환경 변수 (`NEXT_PUBLIC_GEMINI_API_URL`)
- ✅ 미리보기 텍스트 → 설정 파일 (`CHARACTER_PREVIEW.DEFAULT_TEXT`)
- ✅ 그리드 레이아웃 → 설정 파일 (`CHARACTER_LAYOUT`)
- ✅ 모달 크기 → 설정 파일 (`CHARACTER_LAYOUT`)
- ✅ 이미지 Fallback 경로 → 설정 파일 (`IMAGE_FALLBACK`)

### 5.3 타입 안정성 개선 ✅

- ✅ `Voice` 타입 `gender` 필드를 optional로 변경
- ✅ `Voice` 타입에 `description` 필드 추가
- ✅ Persona 파싱 타입 정의 (`ParsedPersona`)

### 5.4 Persona 파싱 개선 ✅

- ✅ Gemini 프롬프트 개선 (구조화된 JSON 요청)
- ✅ Persona 파서 구현 (`parsePersona`, `buildPersonaFromParsed`)
- ✅ 구조화된 필드 자동 추출 (personality, speechStyle, background, goals)

### 5.5 캐싱 전략 개선 ✅

- ✅ Backend: 파일 변경 감지 (mtime 추적)
- ✅ Frontend: 로컬 JSON 우선 로드 (백엔드 폴백)

### 5.6 이미지 처리 개선 ✅

- ✅ 이미지 Fallback 체인 (캐릭터별 → 카테고리별 → 기본 placeholder)
- ✅ Lazy loading 이미지

### 5.7 반응형 디자인 ✅

- ✅ 그리드 레이아웃 반응형화 (모바일 1열, 태블릿 2열, 데스크톱 3열)
- ✅ 모달 크기 반응형화

### 5.8 접근성 개선 ✅

- ✅ 키보드 네비게이션 지원
- ✅ ARIA 레이블 추가
- ✅ 포커스 관리 개선

### 5.9 성능 최적화 ✅

- ✅ 코드 스플리팅 (CharacterCreationWizard lazy load)
- ✅ 메모이제이션 (useCallback, useMemo)
- ✅ 불필요한 리렌더링 방지

### 5.10 네트워크 안정성 개선 ✅

- ✅ `fetchWithTimeout` 구현 (10초 타임아웃)
- ✅ AbortController를 통한 요청 취소
- ✅ 네트워크 에러 명확한 메시지
- ✅ 백엔드 타임아웃 (인증 콜백, Google OAuth)

---

## 6. 문서 정합성 업데이트 필요 사항

### 6.1 미구현_항목_체크리스트.md

**업데이트 필요**:
- ❌ → ✅ TTS API 구현 상태 변경
  - `POST /api/tts` ✅ 구현 완료
  - `GET /api/tts/voices` ✅ 구현 완료
- ❌ → ✅ 캐릭터 선택/생성 기능 추가
  - 캐릭터 선택 모달 ✅ 구현 완료
  - 캐릭터 생성 위저드 ✅ 구현 완료
  - 캐릭터 API ✅ 구현 완료

### 6.2 프로젝트_통합_진행상황_명세서.md

**업데이트 필요**:
- TTS API 섹션: ❌ → ✅ 구현 완료로 변경
- Frontend 진행상황에 캐릭터 선택/생성 기능 추가
- 캐릭터 API 섹션 추가

### 6.3 FINALFINAL.md

**업데이트 필요**:
- TTS API 미구현 목록에서 제거
- 캐릭터 선택/생성 기능 추가
- API 명세에 캐릭터 API 추가

### 6.4 PROJECT_API_SUMMARY.md

**업데이트 필요**:
- TTS API 섹션 상세화 (구현 완료 상태 반영)
- 캐릭터 API 섹션 추가

### 6.5 DATABASE_SCHEMA.md

**확인 필요**:
- Character 모델에 `persona`, `voice_id`, `character` 필드 추가 확인
- AudioFile 모델 확인 (TTS 캐싱용)

---

## 7. ChatRoom API 연동 및 TTS 통합 구현 상세

### 7.1 Backend 구현

#### ✅ Chat API 확장 (`app/api/chat.py`)
- **파일 위치**: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/chat.py`
- **구현 상태**: ✅ 완전 구현 완료
- **인증**: 불필요 (인증 제거됨, 2026-01-26)
- **주요 기능**:
  - `ChatRequest` 모델 확장:
    - `persona`: 페르소나 텍스트 (프론트엔드에서 전달)
    - `session_id`: 세션 ID (선택, 자동 생성)
    - `character_id`: 캐릭터 ID (voice_id 조회용, 현재 미사용)
    - `scenario`: 시나리오 정보 (opponent, situation, background)
    - `tts_enabled`: TTS 활성화 여부 (기본값: True)
    - `tts_mode`: TTS 호출 방식 ("realtime" | "delayed" | "on_click")
    - `tts_delay_ms`: 지연 시간 (밀리초)
    - `tts_streaming_mode`: GPT-SoVITS streaming_mode (0-3)
  - `ChatResponse` 모델 확장:
    - `session_id`: 세션 ID
    - `audio_url`: 생성된 오디오 파일 URL
    - `context_summarized`: 컨텍스트 요약 여부 (Phase 5.2에서 구현 예정)
  - 페르소나 전달 및 포맷팅:
    - 프론트엔드에서 `persona`, `scenario`, `session_id`, `character_id` 전달
    - `format_persona_for_roleplay()` 함수로 역할극 형식으로 포맷팅
    - 포맷팅된 페르소나를 system 메시지로 변환하여 LLM에 전달
  - Character 조회 로직 제거:
    - 인증 제거로 인해 캐릭터 조회 로직 제거 (character_id는 현재 미사용)
  - TTS 통합 로직 (임시 비활성화):
    - 인증 제거로 인해 TTS 통합 로직 임시 비활성화
    - 필요 시 별도 `/api/tts` 엔드포인트 사용
  - 세션 관리:
    - session_id 자동 생성 (없는 경우)
    - UUID 기반 고유 세션 ID

#### ✅ 페르소나 전달 방식 개선
- **파일 위치**: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/chat.py`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - `format_persona_for_roleplay()` 함수:
    - 역할극에 적합한 구조화된 형식으로 페르소나 포맷팅
    - 캐릭터 이름 포함 (있는 경우)
    - 시나리오 정보 포함 (opponent, situation, background)
    - 역할극 지시사항 자동 추가
  - System 메시지 구성:
    - 매 요청마다 system 메시지 포함 (Ollama 요구사항)
    - 포맷팅된 페르소나를 system 메시지로 전달
    - 대화 히스토리와 함께 LLM에 전달
  - 로깅 기능:
    - 개발 환경에서 페르소나 포맷팅 결과 로깅
    - 메시지 배열 길이 로깅
    - DEBUG 환경 변수 기반 조건부 로깅

### 7.2 Frontend 구현

#### ✅ ChatRoom 컴포넌트 (`components/chat-room.tsx`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/components/chat-room.tsx`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - 세션 관리:
    - 채팅방 시작 시 UUID 자동 생성 (`crypto.randomUUID()`)
    - Zustand store에 sessionId 저장
    - 모든 API 호출에 session_id 포함
  - 초기 메시지 생성:
    - `selectedCharacter.sample_dialogue` 우선 사용
    - 없으면 API로 동적 생성 (`chatApi.chat()` 호출)
    - 실시간 TTS 재생 (tts_mode === "realtime"일 때)
  - 실제 API 연동:
    - 하드코딩된 응답 완전 제거
    - `chatApi.chat()` 직접 호출
    - scenario 정보 포함 (opponent, situation, background)
    - TTS 설정 포함 (tts_enabled, tts_mode, tts_delay_ms, tts_streaming_mode)
    - 재시도 메커니즘 (`retryWithBackoff`, 최대 3회, 지수 백오프)
  - TTS 통합:
    - 백엔드 응답의 `audio_url` 처리
    - 메시지에 `audio_url` 저장
    - 실시간 모드: 즉시 오디오 재생
    - 지연 모드: 설정된 시간 후 오디오 재생
    - 클릭 모드: 메시지 클릭 시 오디오 재생
  - 오디오 재생:
    - `useTTS` 훅 사용
    - 상대 경로를 절대 URL로 변환
    - 재생 중 상태 표시 (Volume2 아이콘 펄스)
    - 메시지 클릭 가능 표시 (on_click 모드)
  - 에러 처리:
    - Toast 기반 에러 표시
    - 재시도 카운트 표시
    - 네트워크 에러 명확한 메시지
  - 턴 제한 설정화:
    - 하드코딩 제거
    - Zustand store의 `maxTurns` 사용
    - 환경 변수 `NEXT_PUBLIC_MAX_TURNS` 지원 (기본값: 30)

#### ✅ TTS 설정 모달 (`components/tts-settings-modal.tsx`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/components/tts-settings-modal.tsx`
- **구현 상태**: ✅ 완전 구현 완료
- **주요 기능**:
  - TTS 호출 방식 선택:
    - 실시간: 채팅 응답과 동시에 음성 재생
    - 지연: 설정된 시간 후 음성 재생
    - 클릭: 메시지 클릭 시 음성 재생
  - Streaming Mode 선택:
    - 0-3 라디오 버튼 선택
    - 각 모드 설명 포함
  - 지연 시간 설정:
    - 슬라이더로 0-5000ms 설정
    - 실시간 표시
  - TTS 활성화/비활성화:
    - 토글 스위치
  - 설정 저장:
    - Zustand store에 저장
    - 즉시 적용

#### ✅ Zustand Store 확장 (`lib/store.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/store.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **추가된 상태**:
  - `ttsMode`: "realtime" | "delayed" | "on_click" (기본값: "realtime")
  - `ttsDelayMs`: number (기본값: 0)
  - `ttsStreamingMode`: number (기본값: 0)
  - `ttsEnabled`: boolean (기본값: true)
  - `sessionId`: string | null (기본값: null)
  - `maxTurns`: number (기본값: 30, 환경 변수 지원)
  - `Message` 인터페이스에 `audio_url?: string` 추가

#### ✅ 타입 확장 (`lib/api/types.ts`)
- **파일 위치**: `madcamp-Screening-Humanity-FRONT/lib/api/types.ts`
- **구현 상태**: ✅ 완전 구현 완료
- **확장된 타입**:
  - `ChatRequest`:
    - `session_id?: string`
    - `character_id?: string`
    - `scenario?: { opponent?: string; situation?: string; background?: string }`
    - `tts_enabled?: boolean`
    - `tts_mode?: "realtime" | "delayed" | "on_click"`
    - `tts_delay_ms?: number`
    - `tts_streaming_mode?: number`
  - `ChatResponse`:
    - `audio_url?: string`
    - `session_id?: string`
    - `context_summarized?: boolean`
  - `TTSRequest`:
    - `streaming_mode?: number`
    - `return_binary?: boolean`
    - `text_lang?: string`
    - `prompt_lang?: string`
    - `media_type?: string`

### 7.3 페르소나 전달 방식 개선 구현 상세

#### ✅ format_persona_for_roleplay() 함수
- **위치**: `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/chat.py` (18-59줄)
- **기능**:
  - 캐릭터 이름 포함 (있는 경우): "당신은 {character_name}입니다."
  - 페르소나 설명 포함
  - 시나리오 정보 포함:
    - 현재 상황: {situation}
    - 배경: {background}
    - 상대방: {opponent}
  - 역할극 지시사항 자동 추가:
    - 캐릭터의 성격과 말투 일관성 유지
    - 자연스러운 대화
    - 캐릭터 특성 반영
    - 이전 대화 맥락 고려

#### ✅ 대화 컨텍스트 관리
- **구현 방식**: 매 요청마다 전체 대화 히스토리 포함
- **이유**: Ollama는 매 요청마다 system 메시지를 포함해야 하므로, 현재 구현 방식이 올바름
- **로깅**: 개발 환경에서 메시지 배열 길이 및 페르소나 포맷팅 결과 로깅

---

## 8. 서버 에러 해결 및 백엔드 Gemini SDK 도입 (2026-01-26)

### 8.1 프론트엔드 500 에러 해결 ✅

**문제**: `/api/characters` API가 간헐적으로 500 에러 발생

**해결 방법**:
- ✅ 동기식 파일 처리(`fs.readFileSync`) → 비동기식(`fs.promises`) 전환
- ✅ `Promise.all()`을 사용한 병렬 파일 로드
- ✅ 예외 처리 강화 (각 파일별 try-catch)
- ✅ 디렉토리 존재 확인 (`fs.promises.access`)
- ✅ 파일 타입 확인 (`stats.isFile()`)

**파일 위치**:
- `madcamp-Screening-Humanity-FRONT/app/api/characters/route.ts`

### 8.2 백엔드 Gemini SDK 도입 ✅

**작업 내용**: Google Generative AI SDK (`google-generativeai`) 백엔드 도입

**주요 변경사항**:
- ✅ `requirements.txt`에 `google-generativeai` 패키지 추가
- ✅ `app/api/ai.py` 리팩토링:
  - 공식 Python SDK 사용으로 코드 간소화 및 안정성 향상
  - 비동기 API 호출 (`generate_content_async`)
  - JSON Mode 지원 (`response_mime_type="application/json"`)
  - System Instruction 지원 (`system_instruction` 파라미터)
  - Safety Settings 적용 (기본값: `BLOCK_NONE`)

**환경변수 설정**:
- `GOOGLE_API_KEY`: Gemini API 키 (필수)
- `GOOGLE_API_MODEL`: 사용할 모델 (기본값: `gemini-1.5-flash`)
- `GOOGLE_SAFETY_THRESHOLD`: 안전 설정 (기본값: `BLOCK_NONE`)
- 폴백: `NEXT_PUBLIC_GEMINI_API_KEY` (개발 환경 편의)

**파일 위치**:
- `madcamp-Screening-Humanity-BACK/server-b/backend/app/api/ai.py`
- `madcamp-Screening-Humanity-BACK/server-b/backend/requirements.txt`

**참고 문서** (⚠️ **필수 참고**):
- [Gemini API 사용해보기](https://velog.io/@dyd1308/Gemini-api-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0) - Gemini API 사용 시 반드시 참고
- [Gemini 모델 버전](https://ai.google.dev/gemini-api/docs/models?hl=ko#model-versions) - 모델 선택 시 반드시 참고

---

## 9. 다음 단계 (미구현 항목)

### 9.1 Phase 5.2-5.3 (필수 미구현)

- [ ] Phase 5.2: 컨텍스트 절약 요약 기능
- [ ] Phase 5.3: 동시 접속 제한

---

## 10. 참고 문서

- `.cursor/plans/chatroom_api_연동_및_tts_통합_79dbbc3b.plan.md`
- `.cursor/plans/페르소나_전달_방식_개선_및_대화_컨텍스트_관리_d7205e41.plan.md`
- `.cursor/plans/캐릭터_선택_생성_기능_개선_계획_96bc79de.plan.md`
- `.cursor/plans/tts_api_고급_기능_구현_계획_b4d9a9e0.plan.md`
- `docs/GPT-SoVITS WebAPI(api_v2.py).md`
- `docs/DATABASE_SCHEMA.md`
- **Gemini API 참고 문서**:
  - [Gemini API 사용해보기](https://velog.io/@dyd1308/Gemini-api-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B8%B0)
  - [Gemini 모델 버전](https://ai.google.dev/gemini-api/docs/models?hl=ko#model-versions)

---

**작성자**: AI Assistant  
**최종 업데이트**: 2026-01-26  
**버전**: 3.2 (서버 에러 해결 및 백엔드 Gemini SDK 도입 반영)

**변경 이력**:
- v3.2 (2026-01-26): 서버 에러 해결 및 백엔드 Gemini SDK 도입 반영
  - 프론트엔드 500 에러 해결: `/api/characters` API 비동기 처리 개선 (fs.promises 전환)
  - 백엔드 Gemini SDK 도입: `google-generativeai` 패키지 추가 및 적용
  - 백엔드 SDK 고도화: Safety Settings, JSON Mode 적용
  - 환경변수 기반 설정: GOOGLE_API_KEY, GOOGLE_API_MODEL, GOOGLE_SAFETY_THRESHOLD
  - 참고 문서 추가: Gemini API 사용 가이드 및 모델 버전 문서
- v3.1 (2026-01-26): 캐릭터 생성 위저드 개편 반영
  - Step 1 간소화 (이름, 카테고리, 작품명 3가지만 입력)
  - '다음' 버튼 클릭 시 AI 자동 생성
  - Step 2 통합 편집 (모든 정보 한 화면에서 수정)
  - AI 재생성 횟수 제한 (총 3회)
  - 작품명 필드 추가 (source_work)
  - worldview 필드 추가 (CharacterSpec 인터페이스)
- v3.0 (2026-01-26): 캐릭터 시스템 고도화 작업 완료 반영
  - 데이터 구조 세분화 (persona → 10개 이상의 상세 필드)
  - 파일 기반 관리 시스템 (public/characters/*.json API Route)
  - AI 자동 완성 기능 고도화 (generateCharacterSpec)
  - 프론트엔드 UI/UX 혁신 (CharacterCreationWizard 개편)
  - 시스템 최적화 (페르소나 빌더 시스템)
  - 9종 캐릭터 데이터 마이그레이션 완료
- v2.1 (2026-01-26): 인증 제거 및 프롬프트 전달 수정 반영
  - `/api/chat`, `/api/chat/models` 인증 제거
  - `/api/tts`, `/api/tts/voices` 인증 제거
  - `/api/generate` 인증 제거 (user_id="anonymous")
  - `/api/characters/*` 모든 엔드포인트 인증 제거
  - 프론트엔드에서 persona, scenario, session_id, character_id 전달 확인
  - 백엔드에서 request.persona를 system 메시지로 포맷팅 확인
- v2.0 (2026-01-26): ChatRoom API 연동 및 페르소나 전달 방식 개선 반영
